<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>实现大文件断点续传</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.0/spark-md5.min.js"></script>
</head>
<body>
  <style>
    html, body {
      margin: 0;
      padding: 0;
    }
  </style>
  <p>参考资料：</p>
  <ul>
    <li><a href="https://github.com/xbc30/large-file-upload#nodejs%E5%A4%A7%E6%96%87%E4%BB%B6%E5%88%86%E7%89%87%E4%B8%8A%E4%BC%A0%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0httpwebsocket" target="_blank">[Nodejs大文件分片上传、断点续传(HTTP/WebSocket)]</a></li>
  </ul>
  <div>
    <div
      id="my-input-select"
      style="
        box-sizing: border-box;
        width: 100px;
        height: 100px;
        border: 1px solid lightgray;
        cursor: pointer;
        user-select: none;
      "
    >
      <span
        style="
          width: 100%;
          height: 100%;
          position: relative;
          top: -7px;
          display: flex;
          font-size: 100px;
          justify-content: center;
          align-items: center;
          font-weight: 10;
        "
      >
        +
      </span>
      <input id="input-elm" type="file" style="display: none;">
    </div>

    <div
      id="progress-bar"
      style="
        width: 0%;
        height: 20px;
        background: lightcoral;
        transition: all 1s ease;
      "
    >
    </div>
    
  </div>
  <script type="module">
    import { myAjax } from './assets/utils.js'
    const KB = 1024
    const MB = 1024 * KB
    const GB = 1024 * MB
    const SPLIT_CHUNK_SIZE = 5 * KB // 5KB 分割大小
    const blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice
    
    function updateProgress (update = 1, reset = false) {
      const progressElm = document.getElementById('progress-bar')
      if (reset) {
        progressElm.style.width = '0%'
        return
      }
      const percent = +progressElm.style.width.slice(0, progressElm.style.width.length - 1) + update + '%'
      progressElm.style.width = percent
      progressElm.innerText = `${percent} / 100%`
    }
    function calcFileHash (file) {
      // 计算文件的 hash 值
      return new Promise((resolve, reject) => {
        const totalChunks = Math.ceil(file.size / SPLIT_CHUNK_SIZE) // 一共分为 totalChunks 个区块
        const spark = new SparkMD5.ArrayBuffer()
        const fileReader = new FileReader()
        let currentChunk = 0
        function loadNext () {
          let start = currentChunk * SPLIT_CHUNK_SIZE,
            end = start + SPLIT_CHUNK_SIZE > file.size ?
              file.size :
              start + SPLIT_CHUNK_SIZE
          fileReader.readAsArrayBuffer(blobSlice.call(file, start, end))
        }
        fileReader.onload = (e) => {
          // 对当前读取完的分片进行 md5 加工
          spark.append(e.target.result)
          currentChunk++
          if (currentChunk < totalChunks) {
            loadNext()
          } else {
            resolve({ md5: spark.end(), chunkTotal: currentChunk })
          }
        }
        fileReader.onerror = (error) => {
          reject(new Error('计算切片哈希值失败，请重新选择文件～'))
        }
        loadNext()
      }).catch(err => {
        console.log(err)
      })
    }
    async function startUpload () {
      
      return myAjax({
        url: 'upload',
        data: JSON.stringify({ md5: '', totalChunks: 1 }),
        method: 'POST',
        onUploadProgress: (event) => {
          updateProgress.call(this, 0, true)
          updateProgress.call(this, Math.ceil(event.loaded / event.total) * 100)
        }
      })
    }
    window.addEventListener('DOMContentLoaded', function () {
      const inputSelectArea = document.getElementById('my-input-select')
      const inputElm = document.getElementById('input-elm')
      inputSelectArea.addEventListener('click', function (e) {
        // inputElm.click()
        inputElm.dispatchEvent(new MouseEvent('click'))
      })

      inputElm.addEventListener('change', async function (e) {
        if (this.files && this.files.length > 0) {
          const file = this.files[0]
          const { md5, chunkTotal } = await calcFileHash(file)
          await startUpload()
          console.log('上传完成')
          return
        }
        throw Error('获取文件失败，请重试')
      })
    })
  </script>
</body>
</html>